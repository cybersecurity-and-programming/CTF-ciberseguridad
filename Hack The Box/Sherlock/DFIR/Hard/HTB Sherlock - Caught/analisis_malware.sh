#!/bin/bash

# Colores profesionales
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

# Validar argumento
if [ -z "$1" ]; then
    echo -e "${RED}Error:${RESET} Debes especificar una ruta a analizar."
    echo "Uso: $0 /ruta/a/analizar"
    exit 1
fi

TARGET="$1"
INJECTION_APIS=("VirtualAlloc" "VirtualProtect" "WriteProcessMemory" "CreateRemoteThread" "OpenProcess")
NETWORK_APIS=("WinHttpOpen" "WinHttpConnect" "InternetOpen" "InternetReadFile" "WSAStartup" "connect" "send" "recv")
EVASION_APIS=("IsDebuggerPresent" "CheckRemoteDebuggerPresent" "NtQueryInformationProcess" "OutputDebugString")

# Señales forenses
HAS_INJECTION=0
HAS_NETWORK=0
HAS_EVASION=0
HAS_HIGH_ENTROPY=0
HAS_PACKER=0

# Validar que la ruta existe
if [ ! -d "$TARGET" ]; then
    echo -e "${RED}Error:${RESET} La ruta '$TARGET' no existe o no es un directorio."
    exit 1
fi

# Función para colorear según severidad
color_entropy() {
    local value=$1
    if (( $(echo "$value > 7.2" | bc -l) )); then
        echo -e "${RED}${value}${RESET}"
    elif (( $(echo "$value > 6.5" | bc -l) )); then
        echo -e "${YELLOW}${value}${RESET}"
    else
        echo -e "${GREEN}${value}${RESET}"
    fi
}

for f in "$TARGET"/*; do
    if [ -f "$f" ]; then
        echo -e "${GREEN}======== Análisis de: $f ========${RESET}"

        echo -e "${GREEN}Nombre del archivo:${RESET} $f"
        echo -e "${GREEN}Tamaño:${RESET} $(stat -c%s "$f") bytes"
        echo -e "${GREEN}Tipo:${RESET} $(file -b "$f")"
        echo -e "${GREEN}MIME:${RESET} $(file --mime-type -b "$f")"

        echo -e "${GREEN}MD5:${RESET} $(md5sum "$f" | awk '{print $1}')"
        echo -e "${GREEN}SHA1:${RESET} $(sha1sum "$f" | awk '{print $1}')"
        echo -e "${GREEN}SHA256:${RESET} $(sha256sum "$f" | awk '{print $1}')"

        echo -e "${GREEN}Creado:${RESET} $(stat -c %w "$f" 2>/dev/null)"
        echo -e "${GREEN}Modificado:${RESET} $(stat -c %y "$f")"
        echo -e "${GREEN}Accedido:${RESET} $(stat -c %x "$f")"

        ENTROPY=$(ent "$f" | grep Entropy | awk '{print $3}')
        echo -e "${GREEN}Entropía:${RESET} $(color_entropy $ENTROPY)"

        # Detectar packers
        PACKER_DETECTED="No"
        if strings "$f" | grep -qi "UPX"; then PACKER_DETECTED="UPX" HAS_PACKER=1; fi
        if strings "$f" | grep -qi "ASPack"; then PACKER_DETECTED="ASPack" HAS_PACKER=1; fi
        if strings "$f" | grep -qi "Themida"; then PACKER_DETECTED="Themida" HAS_PACKER=1; fi

        if [ "$PACKER_DETECTED" != "No" ]; then
            echo -e "${RED}Packer detectado:${RESET} $PACKER_DETECTED"
        else
            echo -e "${GREEN}Packer detectado:${RESET} Ninguno"
        fi

        # Análisis PE
        if file "$f" | grep -q "PE32"; then
            echo -e "${GREEN}Archivo PE detectado:${RESET} Sí"
            echo -e "${GREEN}Secciones PE:${RESET}"

            python3 - <<EOF
import pefile
try:
    pe = pefile.PE("$f")
    for section in pe.sections:
        name = section.Name.decode().rstrip('\x00')
        entropy = section.get_entropy()
        color = "\033[31m" if entropy > 7.2 else ("\033[33m" if entropy > 6.5 else "\033[32m")
        print(f"{color} - {name} | Entropía: {entropy:.2f}\033[0m")
except:
    print("\033[31mError leyendo estructura PE\033[0m")
EOF

            echo -e "${GREEN}Imports:${RESET}"
            python3 - <<EOF
import pefile
try:
    pe = pefile.PE("$f")
    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            print(f"  {entry.dll.decode()}")
            for imp in entry.imports:
                print(f"    - {imp.name}")
    else:
        print("  No hay tabla de imports")
except:
    print("  Error leyendo imports")
EOF

            echo -e "${GREEN}Exports:${RESET}"
            python3 - <<EOF
import pefile
try:
    pe = pefile.PE("$f")
    if hasattr(pe, 'DIRECTORY_ENTRY_EXPORT'):
        for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols:
            print(f"  - {exp.name}")
    else:
        print("  No hay tabla de exports")
except:
    print("  Error leyendo exports")
EOF
        fi

        # Análisis MSI
        if file "$f" | grep -q "MSI"; then
            echo -e "${GREEN}Archivo MSI detectado:${RESET} Sí"
            echo -e "${GREEN}Metadatos MSI:${RESET}"

            TMPDIR=$(mktemp -d)
            7z x "$f" -o"$TMPDIR" >/dev/null 2>&1

            if [ -f "$TMPDIR/Property" ]; then
                grep -E "ProductName|Manufacturer|ProductVersion|ProductCode" "$TMPDIR/Property"
            else
                echo -e "${YELLOW}No se encontró tabla Property${RESET}"
            fi

            echo -e "${GREEN}Streams MSI:${RESET}"
            ls "$TMPDIR" | sed 's/^/  - /'

            rm -rf "$TMPDIR"
        fi

        if (( $(echo "$ENTROPY > 7.2" | bc -l) )); then
            HAS_HIGH_ENTROPY=1
        fi

        if [ "$PACKER_DETECTED" != "No" ]; then
            HAS_PACKER=1
        fi

        # Detectar APIs sospechosas en imports
        for api in "${INJECTION_APIS[@]}"; do
            if grep -q "$api" <<< "$IMPORTS_RAW"; then
                HAS_INJECTION=1
            fi
        done

        for api in "${NETWORK_APIS[@]}"; do
            if grep -q "$api" <<< "$IMPORTS_RAW"; then
                HAS_NETWORK=1
            fi
        done

        for api in "${EVASION_APIS[@]}"; do
            if grep -q "$api" <<< "$IMPORTS_RAW"; then
                HAS_EVASION=1
            fi
        done

        IMPORTS_RAW=$(python3 - <<EOF
import pefile
try:
    pe = pefile.PE("$f")
    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            for imp in entry.imports:
                if imp.name:
                    print(imp.name.decode())
except:
    pass
EOF
)
        echo -e "${GREEN}Resumen forense:${RESET}"

        [ $HAS_INJECTION -eq 1 ] && echo -e "  - Señales de inyección detectadas" || echo -e "  - Sin señales de inyección"
        [ $HAS_NETWORK -eq 1 ] && echo -e "  - Señales de comunicación de red detectadas" || echo -e "  - Sin señales de red"
        [ $HAS_EVASION -eq 1 ] && echo -e "  - Señales de evasión detectadas" || echo -e "  - Sin señales de evasión"
        [ $HAS_HIGH_ENTROPY -eq 1 ] && echo -e "  - Entropía elevada" || echo -e "  - Entropía normal"
        [ $HAS_PACKER -eq 1 ] && echo -e "  - Packer detectado" || echo -e "  - Sin packer"

        # Calcular riesgo forense
        RISK=$((HAS_INJECTION + HAS_NETWORK + HAS_EVASION + HAS_HIGH_ENTROPY + HAS_PACKER))

        if [ $RISK -ge 4 ]; then
            echo -e "${RED}Evaluación forense: RIESGO ALTO${RESET}"
        elif [ $RISK -ge 2 ]; then
            echo -e "${YELLOW}Evaluación forense: RIESGO MEDIO${RESET}"
        else
            echo -e "${GREEN}Evaluación forense: RIESGO BAJO${RESET}"
        fi

        echo
    fi
done
